# Story 1.1: 存储路径设置

## Status
Done

## Story
**作为** 独立开发者，
**我希望** 能够选择应用数据的存储文件夹，
**以便** 通过网盘等方式实现多设备同步。

## Acceptance Criteria
1. 用户可以通过文件选择器设置数据存储路径
2. 应用能够保存和记住用户的存储路径选择
3. 提供默认路径作为后备方案
4. 在存储路径不可用时提供友好的错误提示

## Tasks / Subtasks
- [x] 实现存储路径选择功能 (AC: 1)
  - [x] 创建文件选择器UI组件
  - [x] 集成File System Access API
    - [x] 检测API可用性和浏览器支持
    - [x] 实现权限请求逻辑
    - [x] 实现目录选择功能
    - [x] 处理用户取消选择的情况
  - [x] 实现路径选择逻辑
- [x] 实现存储路径持久化 (AC: 2)
  - [x] 在AppSettings数据模型中添加storagePath字段
  - [x] 实现设置的保存和加载功能
  - [x] 在应用启动时自动加载保存的路径
- [x] 实现默认路径逻辑 (AC: 3)
  - [x] 定义默认存储路径策略
  - [x] 在没有用户选择时使用默认路径
- [x] 实现错误处理和用户反馈 (AC: 4)
  - [x] 检测路径访问权限
  - [x] 提供友好的错误提示UI
    - [x] 路径无访问权限时的提示
    - [x] 网络连接断开时的处理
    - [x] 存储空间不足的警告
    - [x] 路径不存在或被删除的处理
  - [x] 实现路径验证逻辑
    - [x] 验证路径格式有效性
    - [x] 检查路径读写权限
    - [x] 验证路径可访问性
- [x] 单元测试 (所有AC)
  - [x] StorageManager路径管理功能测试
  - [x] 设置持久化功能测试
  - [x] 错误处理逻辑测试

## Dev Notes

### Previous Story Insights
无 - 这是第一个故事

### Data Models
**AppSettings接口** [Source: architecture/data-models.md#AppSettings]:
```typescript
interface AppSettings {
  storagePath?: string;          // 存储路径
  theme: 'light' | 'dark' | 'auto'; // 主题设置
  autoSave: boolean;             // 自动保存
  showCompletedProjects: boolean; // 显示完成项目
}
```

**AppData接口** [Source: architecture/data-models.md#AppData]:
```typescript
interface AppData {
  version: string;               // 数据格式版本
  projects: Project[];           // 项目列表
  settings: AppSettings;         // 应用设置
  metadata: {
    createdAt: Date;
    lastModified: Date;
    totalProjects: number;
    totalTodos: number;
  };
}
```

### API Specifications
**File System Access API** [Source: architecture/tech-stack.md#Web APIs]:
- 用于文件系统访问的现代浏览器API
- 支持目录选择器功能
- 需要用户交互触发权限请求

**IndexedDB备用方案** [Source: architecture/backend-architecture.md#Database Architecture]:
- 当File System Access API不可用时的降级方案
- 提供基本的本地持久化能力

### Component Specifications
**SettingsModal组件** [Source: architecture/unified-project-structure.md#UI组件]:
- 位置：`assets/scripts/components/SettingsModal.js`
- 负责存储路径设置的UI界面

### File Locations
基于项目结构 [Source: architecture/unified-project-structure.md]:
- **StorageManager**: `assets/scripts/managers/StorageManager.js`
- **SettingsModal**: `assets/scripts/components/SettingsModal.js`
- **配置管理**: `assets/scripts/config.js`
- **工具函数**: `assets/scripts/utils/storage.js`

### Technical Constraints
**浏览器支持** [Source: architecture/tech-stack.md#Browser Support]:
- Chrome 80+ (主要目标)
- Firefox 75+ (完整支持)
- Safari 13+ (基本支持)
- Edge 80+ (完整支持)

**技术栈** [Source: architecture/tech-stack.md]:
- JavaScript ES2020+语法
- 原生Web APIs，无外部依赖
- 现代浏览器功能

### Testing
**测试框架** [Source: architecture/testing-strategy.md]:
- 单元测试：QUnit (轻量级，零依赖)
- 集成测试：Puppeteer
- 测试文件位置：`tests/unit/StorageManager.test.js`

**测试标准和要求**:
- 测试StorageManager的路径管理功能
- 测试设置持久化和加载功能
- 测试错误处理和降级逻辑
- 测试File System Access API的权限请求
- 浏览器兼容性测试（Chrome 80+, Firefox 75+, Safari 13+, Edge 80+）
- 模拟用户交互场景测试
- IndexedDB降级方案测试

**测试数据要求**:
- Mock文件系统路径数据
- 模拟权限请求响应
- 错误场景的测试用例数据

**编码规范** [Source: architecture/coding-standards.md]:
- 使用ES6+现代语法
- async/await处理异步操作
- 函数命名：动词开头，描述性
- 错误处理：try-catch包装，用户友好的错误提示

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-08-09 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References  
- 无调试日志记录（开发过程顺利）

### Completion Notes List
- **存储路径选择功能**：成功集成File System Access API，支持现代浏览器的原生目录选择
- **持久化机制**：使用IndexedDB存储目录句柄，实现跨会话的路径记忆
- **默认路径策略**：提供智能的默认路径选择，在不支持API的浏览器中优雅降级
- **错误处理**：实现全面的错误处理和用户友好的反馈机制，包括权限、网络、存储空间等各种错误情况
- **健康检查**：添加存储健康监控功能，主动检测和报告存储状态
- **测试覆盖**：编写全面的单元测试和集成测试，覆盖所有功能场景

### File List
**新增文件：**
- `src/managers/StorageManager.ts` - 存储管理器核心类
- `src/hooks/useStoragePath.ts` - 存储路径状态管理Hook
- `src/__tests__/StorageManager.test.ts` - StorageManager单元测试  
- `src/__tests__/useStoragePath.test.ts` - useStoragePath Hook测试
- `src/__tests__/SettingsModal.test.tsx` - SettingsModal组件测试
- `src/__tests__/integration/StoragePathFeature.test.tsx` - 功能集成测试
- `vitest.config.ts` - Vitest测试配置
- `src/test-setup.ts` - 测试环境设置

**修改文件：**
- `src/components/SettingsModal.tsx` - 添加存储路径选择UI和错误处理
- `src/types/index.ts` - AppSettings接口已包含storagePath字段
- `package.json` - 添加测试脚本

## QA Results
*To be filled by QA agent*