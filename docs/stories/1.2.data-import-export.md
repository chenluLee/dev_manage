# Story 1.2: 数据导入导出

## Status
Done

## Story
**作为** 独立开发者，
**我希望** 能够导入和导出项目数据，
**以便** 备份和迁移数据。

## Acceptance Criteria
1. 支持JSON格式的数据导入导出
2. 导出文件包含所有项目和任务数据
3. 导入时能够验证数据格式完整性
4. 提供导入预览和确认功能
5. 支持从常见Todo工具导入数据

## Tasks / Subtasks
- [x] 实现数据导出功能 (AC: 1, 2)
  - [x] 创建JSON数据导出接口
  - [x] 确保导出包含完整的AppData结构
  - [x] 实现文件下载功能
  - [x] 添加导出状态和进度反馈
- [x] 实现数据导入功能 (AC: 1, 3)
  - [x] 创建文件选择器UI组件
  - [x] 实现JSON文件解析功能
  - [x] 集成数据验证API
  - [x] 处理导入错误和异常情况
- [x] 实现导入预览功能 (AC: 4)
  - [x] 创建导入预览界面
  - [x] 显示将要导入的项目和任务统计
  - [x] 提供确认和取消选项
  - [x] 实现增量导入和完全替换选项
- [x] 支持第三方工具导入 (AC: 5)
  - [x] 研究并实现Todoist格式支持
  - [x] 研究并实现Trello格式支持
  - [x] 创建格式转换器模块
  - [x] 提供格式检测和提示功能
- [x] 单元测试 (所有AC)
  - [x] StorageAPI导入导出功能测试
  - [x] ValidationAPI数据验证测试
  - [x] 格式转换器测试
  - [x] 用户界面交互测试

## Dev Notes

### Previous Story Insights
来自Story 1.1 [Source: docs/stories/1.1.storage-path-setup.md]:
- StorageManager已实现基础的文件系统访问功能
- File System Access API权限机制已建立
- IndexedDB降级方案已验证可用
- 错误处理和用户反馈机制已完善

### Data Models
**AppData接口** [Source: architecture/data-models.md#AppData]:
```typescript
interface AppData {
  version: string;               // 数据格式版本
  projects: Project[];           // 项目列表
  settings: AppSettings;         // 应用设置
  metadata: {
    createdAt: Date;
    lastModified: Date;
    totalProjects: number;
    totalTodos: number;
  };
}
```

**Project接口** [Source: architecture/data-models.md#Project]:
```typescript
interface Project {
  id: string;                    // 唯一标识符
  name: string;                  // 项目名称
  description?: string;          // 项目描述
  status: 'active' | 'completed'; // 项目状态
  createdAt: Date;               // 创建时间
  updatedAt: Date;               // 更新时间
  order: number;                 // 排序权重
  urls?: ProjectUrl[];           // 快速访问链接
  tags?: string[];               // 项目标签
  todos: Todo[];                 // 嵌套任务列表
}
```

**Todo接口** [Source: architecture/data-models.md#Todo]:
```typescript
interface Todo {
  id: string;                    // 唯一标识符
  content: string;               // 任务内容
  status: 'pending' | 'in-progress' | 'completed'; // 任务状态
  priority: 'low' | 'medium' | 'high'; // 优先级
  createdAt: Date;               // 创建时间
  updatedAt: Date;               // 更新时间
  order: number;                 // 排序权重
  tags?: string[];               // 任务标签
  subtasks?: Subtask[];          // 子任务列表
}
```

### API Specifications
**Storage API** [Source: architecture/api-specification.md#Storage API]:
```javascript
// 导出数据
StorageAPI.exportData(format)
// 参数: format: 'json' | 'csv'
// 返回: Promise<Blob>

// 导入数据
StorageAPI.importData(file)
// 参数: file: File
// 返回: Promise<AppData>

// 保存数据到文件系统
StorageAPI.saveToFile(data, filename?)
// 参数: data: AppData, filename?: string
// 返回: Promise<boolean>

// 从文件系统加载数据
StorageAPI.loadFromFile()
// 返回: Promise<AppData | null>
```

**Validation API** [Source: architecture/api-specification.md#Validation API]:
```javascript
// 验证导入数据完整性
ValidationAPI.validateImportData(data)
// 参数: data: any
// 返回: {valid: boolean, errors: string[], warnings: string[]}
```

### Component Specifications
**导入导出界面组件** [Source: architecture/unified-project-structure.md#UI组件]:
- 位置：`assets/scripts/components/ImportExportModal.js`
- 负责数据导入导出的用户界面

**文件选择器组件**：
- 利用现有的File System Access API集成
- 支持.json文件类型筛选
- 提供拖放上传功能

### File Locations
基于项目结构 [Source: architecture/unified-project-structure.md]:
- **ImportExportModal**: `assets/scripts/components/ImportExportModal.js`
- **数据转换器**: `assets/scripts/utils/dataConverters.js`
- **格式检测**: `assets/scripts/utils/formatDetector.js`
- **Storage API扩展**: `assets/scripts/managers/StorageManager.js` (现有文件扩展)
- **Validation扩展**: `assets/scripts/utils/validation.js` (现有文件扩展)

### Technical Constraints
**浏览器支持** [Source: architecture/tech-stack.md#Browser Support]:
- Chrome 80+ (主要目标)
- Firefox 75+ (完整支持)
- Safari 13+ (基本支持)
- Edge 80+ (完整支持)

**技术栈** [Source: architecture/tech-stack.md]:
- JavaScript ES2020+语法
- 原生Web APIs，无外部依赖
- File System Access API（已在Story 1.1中验证）

**数据格式约束**：
- JSON格式必须符合AppData接口结构
- 支持向后兼容的版本控制
- 文件大小限制（合理范围内）

### Testing
**测试框架** [Source: architecture/testing-strategy.md]:
- 单元测试：QUnit (轻量级，零依赖)
- 集成测试：Puppeteer
- 测试文件位置：`tests/unit/ImportExport.test.js`

**测试标准和要求**:
- 测试JSON数据导出的完整性和格式正确性
- 测试导入功能的数据验证和错误处理
- 测试第三方格式转换器的准确性
- 测试导入预览界面的数据显示
- 测试文件选择器和拖放功能
- 测试大文件导入的性能和内存使用
- 模拟各种导入错误场景（格式错误、文件损坏等）

**测试数据要求**:
- 创建多种格式的示例导出文件
- 准备第三方工具的示例数据文件
- 构建无效数据的测试用例
- 大数据量的性能测试用例

**编码规范** [Source: architecture/coding-standards.md]:
- 使用ES6+现代语法
- async/await处理异步操作
- 函数命名：动词开头，描述性
- 错误处理：try-catch包装，用户友好的错误提示

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-08-09 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References  
- 无调试日志记录（开发过程顺利）

### Completion Notes List
- **数据导出功能**：成功扩展StorageManager，支持JSON格式数据导出和文件下载功能，包含完整的AppData结构
- **数据导入功能**：实现文件选择器UI和完整的JSON文件解析功能，集成数据验证API确保导入数据完整性
- **导入预览功能**：创建专业的ImportExportModal组件，提供详细的导入预览界面，显示项目和任务统计，支持确认和取消操作
- **数据验证系统**：开发全面的DataValidator类，支持严格的数据结构验证、ID唯一性检查、数据清理和标准化
- **第三方格式支持**：实现FormatConverter模块，支持Todoist和Trello格式自动检测和转换，包括项目、任务、子任务的完整映射
- **错误处理机制**：完善的错误处理和用户友好的反馈机制，支持多种错误类型的专门处理
- **测试覆盖**：编写全面的单元测试，覆盖所有核心功能模块，包括StorageManager扩展、数据验证、格式转换和UI组件测试

### File List
**新增文件：**
- `src/components/ImportExportModal.tsx` - 专业的数据导入导出Modal组件
- `src/utils/dataValidation.ts` - 数据验证和标准化模块  
- `src/utils/formatConverters.ts` - 第三方格式转换器模块
- `src/__tests__/StorageManagerImportExport.test.ts` - StorageManager导入导出功能测试
- `src/__tests__/DataValidator.test.ts` - 数据验证模块测试
- `src/__tests__/FormatConverter.test.ts` - 格式转换器模块测试
- `src/__tests__/ImportExportModal.test.tsx` - ImportExportModal组件测试

**修改文件：**
- `src/managers/StorageManager.ts` - 扩展导入导出API和数据验证功能
- `src/test-setup.ts` - 更新测试设置以支持vitest兼容

## QA Results
*To be filled by QA agent*