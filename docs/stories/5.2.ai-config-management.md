# Story 5.2: AI配置管理

## Status
Done

## Story

**As a** 独立开发者，  
**I want** 能够在系统设置中配置AI模型的相关参数，  
**so that** 我可以根据自己的环境和需求自定义报告生成的行为和质量。

## Acceptance Criteria

1. **设置界面扩展：** 在现有的SettingsModal组件中新增"AI报告生成"配置区块，遵循现有的设置项布局和样式模式
2. **Ollama URL配置：** 提供文本输入框配置Ollama服务器URL，默认值为"http://localhost:11434"，支持URL格式验证
3. **模型名称配置：** 提供文本输入框配置AI模型名称，默认值为"llama3.2"，支持模型名称格式验证
4. **温度参数配置：** 提供数字输入控件配置温度参数，默认值为0.7，范围限制在0-2之间，步长为0.1
5. **配置持久化：** AI配置参数保存到AppSettings数据模型中，与其他设置一同持久化存储
6. **配置验证：** 提供基本的参数验证功能，包括URL格式检查、数值范围验证
7. **默认值处理：** 首次使用时自动应用默认配置值，确保功能可用性
8. **连接测试：** 提供"测试连接"按钮，验证Ollama服务的可达性（可选功能）

## Tasks / Subtasks

- [x] **AppSettings数据模型扩展** (AC: 5, 7)
  - [x] 在 `src/types/index.ts` 中为 `AppSettings` 接口添加 `aiReport?` 配置字段
  - [x] 定义AI配置子接口包含 `ollamaUrl`, `modelName`, `temperature` 字段
  - [x] 设置合适的默认值和类型约束

- [x] **SettingsModal界面扩展** (AC: 1, 2, 3, 4)
  - [x] 在 `src/components/SettingsModal.tsx` 中新增"AI报告生成"配置区块
  - [x] 添加Ollama URL输入框，使用Input组件，默认值 "http://localhost:11434"
  - [x] 添加模型名称输入框，使用Input组件，默认值 "llama3.2"
  - [x] 添加温度参数输入框，使用number类型Input，范围0-2，步长0.1，默认0.7
  - [x] 遵循现有设置区块的布局和样式模式

- [x] **配置验证逻辑** (AC: 6)
  - [x] 实现URL格式验证函数，检查基本URL格式有效性
  - [x] 实现温度参数范围验证（0-2之间）
  - [x] 添加模型名称基本格式检查（非空、合理长度）
  - [x] 在输入时提供实时验证反馈

- [x] **配置状态管理** (AC: 5, 7)
  - [x] 更新 `onSettingsUpdate` 调用处理AI配置变更
  - [x] 确保AI配置与其他设置一同保存到存储
  - [x] 处理配置初始化，应用默认值给新用户

- [x] **连接测试功能** (AC: 8) - 可选
  - [x] 添加"测试连接"按钮，使用现有Button组件样式
  - [x] 实现基础的Ollama API连通性检查
  - [x] 提供测试结果反馈（成功/失败状态显示）
  - [x] 添加适当的加载状态和错误处理

- [x] **UI样式和布局** (AC: 1)
  - [x] 为AI配置区块添加合适的图标（可使用 Settings2 或 Bot 图标）
  - [x] 确保新配置区块与现有设置项视觉一致
  - [x] 测试不同屏幕尺寸下的布局表现
  - [x] 添加必要的帮助文本和提示信息

- [x] **测试和验证** (AC: 1-8)
  - [x] 测试配置项的保存和加载功能
  - [x] 验证表单验证逻辑的正确性
  - [x] 测试默认值的自动应用
  - [x] 验证配置更新不影响其他设置功能

## Dev Notes

### 系统架构上下文
基于项目架构和已完成的Story 5.1实现，该功能需要扩展现有的设置管理系统：

- **技术栈：** React 18 + TypeScript + Vite，使用 ShadCN UI 组件库
- **设置管理：** 基于现有的SettingsModal组件和AppSettings数据模型
- **数据持久化：** 通过StorageManager与其他设置一同保存

### 相关源码结构
```
src/
├── types/index.ts              # 需要扩展AppSettings接口，添加aiReport配置
├── components/
│   └── SettingsModal.tsx       # 主要修改点：添加AI配置区块
├── hooks/
│   └── useProjects.ts          # 可能需要传递新的设置更新逻辑
└── managers/
    └── StorageManager.ts       # 确保AI配置被正确持久化
```

### 现有模式参考
基于SettingsModal.tsx的现有实现模式：

- **设置区块结构：** 参考第259-332行的"数据备份"区块布局模式
- **输入控件模式：** 参考第283-296行的备份间隔数字输入实现
- **开关控件模式：** 参考第272-277行的自动备份Switch组件使用
- **验证反馈：** 参考第159-163行的错误提示Alert组件模式

### 集成Story 5.1的已有改动
- **数据模型基础：** Todo和Subtask的completedAt字段已实现
- **组件更新：** TodoItem.tsx和SubtaskItem.tsx已导入date-fns并实现时间戳功能
- **类型系统：** 完成时间相关的TypeScript类型已定义

### 关键实现注意事项
1. **配置数据结构：** 
   ```typescript
   aiReport?: {
     ollamaUrl: string;
     modelName: string;
     temperature: number;
   }
   ```

2. **UI集成点：** 在现有设置区块后添加新的AI配置区块，使用相同的spacing和layout模式

3. **验证逻辑：** 
   - URL验证：基础HTTP/HTTPS格式检查
   - 温度验证：数值范围0-2，步长0.1
   - 模型名称：非空字符串，长度限制

4. **默认值处理：** 在useEffect或初始化逻辑中应用默认配置

### 与Epic 5后续故事的关联
- **为Story 5.3提供配置基础：** 报告生成界面将读取这些AI配置
- **为Story 5.4提供API参数：** AI报告生成将使用这些配置调用Ollama

### Testing

#### 测试文件位置和标准
基于项目架构和Story 5.1的成功实现，测试文件应放置在：
- `src/__tests__/SettingsModal.test.tsx` - 扩展现有设置模态框测试
- `src/__tests__/types/AIConfigTypes.test.ts` - AI配置类型定义测试
- `src/__tests__/utils/AIConfigValidation.test.ts` - 配置验证逻辑测试

#### 测试框架和工具
继续使用项目标准测试技术栈：
- **测试框架：** Vitest
- **组件测试：** @testing-library/react + @testing-library/jest-dom
- **用户交互：** @testing-library/user-event
- **测试环境：** jsdom

#### 具体测试要求

##### 单元测试
1. **数据模型测试**
   - 验证 `AppSettings.aiReport` 字段的可选性和结构
   - 测试AI配置默认值的正确应用
   - 验证配置对象的序列化和反序列化

2. **配置验证测试**
   - 测试URL格式验证（有效/无效URL）
   - 验证温度参数范围检查（0-2之间）
   - 测试模型名称格式验证（非空、长度限制）
   - 边界值测试（温度0、2、超出范围值）

3. **组件行为测试**
   - 测试AI配置区块的正确渲染
   - 验证输入控件的双向数据绑定
   - 测试配置更新时的onSettingsUpdate调用
   - 验证默认值的自动填充

##### 集成测试
1. **SettingsModal集成测试**
   - 验证AI配置与其他设置项的协调工作
   - 测试配置保存和加载的完整流程
   - 验证模态框打开关闭时配置状态的保持

2. **数据持久化测试**
   - 验证StorageManager正确保存AI配置
   - 测试应用重启后配置的正确恢复
   - 验证导入导出功能包含AI配置数据

##### 用户界面测试
1. **视觉一致性测试**
   - 确保AI配置区块与现有设置项样式一致
   - 验证不同屏幕尺寸下的布局表现
   - 测试输入验证错误提示的显示

2. **交互测试**
   - 模拟用户输入配置参数的完整流程
   - 测试连接测试按钮（如实现）的交互
   - 验证键盘导航和可访问性

##### 连接测试功能测试（如实现）
1. **API连通性测试**
   - 模拟成功的Ollama连接测试
   - 测试连接失败的错误处理
   - 验证测试过程中的加载状态显示

#### 测试覆盖率要求
- 新增代码行覆盖率 ≥ 90%
- 分支覆盖率 ≥ 85%
- 配置验证逻辑覆盖率 = 100%

#### 回归测试
- 确保Story 5.1的完成时间功能不受影响
- 验证现有设置功能的正常工作
- 测试数据模型向后兼容性

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-14 | 1.0 | 初始故事创建，基于Epic 5需求和Story 5.1成功实现 | BMad Master |

## Dev Agent Record

*(This section is owned by dev-agent and can only be modified by dev-agent)*

### Agent Model Used
Claude-Sonnet-4-20250514

### Debug Log References
- 无重大问题或错误需要记录
- 所有测试均通过验证

### Completion Notes List
1. **数据模型成功扩展**: 在 `AppSettings` 接口中添加了 `aiReport?` 可选字段，包含 `ollamaUrl`, `modelName`, `temperature` 三个配置项
2. **UI界面完整实现**: 在 `SettingsModal.tsx` 中新增了完整的AI配置区块，采用Bot图标，布局与现有设置项保持一致
3. **验证逻辑健全**: 创建了独立的验证工具模块 `aiConfigValidation.ts`，实现URL、模型名称、温度参数的完整验证
4. **连接测试功能**: 实现了Ollama服务连通性测试，支持超时处理、错误状态显示、加载状态
5. **测试覆盖完整**: 为验证逻辑和UI组件编写了全面的单元测试，覆盖所有边界情况

### File List
- src/types/index.ts - 扩展AppSettings接口添加aiReport配置
- src/components/SettingsModal.tsx - 新增AI配置区块和连接测试功能
- src/utils/aiConfigValidation.ts - AI配置验证逻辑工具模块
- src/__tests__/utils/aiConfigValidation.test.ts - 验证逻辑单元测试
- src/__tests__/components/SettingsModal.aiconfig.test.tsx - AI配置UI组件测试

## QA Results

*(This section is owned by qa-agent and can only be modified by qa-agent)*

*(Results from QA Agent QA review of the completed story implementation - to be populated during QA phase)*