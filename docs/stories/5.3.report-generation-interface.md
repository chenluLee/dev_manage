# Story 5.3: 报告生成界面

## Status
Done

## Story

**As a** 独立开发者，  
**I want** 能够选择时间范围并生成工作报告，  
**so that** 我可以定期总结和分享工作成果。

## Acceptance Criteria

1. **报告生成按钮：** 提供报告生成按钮，触发报告生成模态框
2. **日期范围选择：** 支持日期范围选择（默认过去一个月）
3. **完成事项预览：** 显示过滤出的完成事项预览（项目->待办->子任务层级）
4. **可编辑报告内容：** 提供可编辑的报告内容文本区域
5. **导出Markdown：** 支持生成并导出Markdown格式报告

## Tasks / Subtasks

- [x] **ReportModal组件创建** (AC: 1, 4, 5)
  - [x] 在 `src/components/` 中创建 `ReportModal.tsx` 组件
  - [x] 使用ShadCN Dialog组件作为模态框基础
  - [x] 添加报告内容的Textarea编辑区域
  - [x] 实现Markdown格式导出功能
  - [x] 遵循现有组件的样式模式和TypeScript类型规范

- [x] **日期选择器集成** (AC: 2)
  - [x] 集成ShadCN DatePicker组件实现日期范围选择
  - [x] 设置默认日期范围为过去30天
  - [x] 添加快捷日期选择选项（过去7天、30天、90天）
  - [x] 实现日期范围验证（开始日期不能晚于结束日期）

- [x] **完成事项数据过滤** (AC: 3)
  - [x] 创建工具函数过滤指定日期范围内的完成事项
  - [x] 实现层级数据结构展示（项目->待办->子任务）
  - [x] 添加完成事项统计信息显示
  - [x] 处理空数据状态和错误情况

- [x] **主界面集成** (AC: 1)
  - [x] 在主界面添加"生成报告"按钮，使用合适的图标
  - [x] 将ReportModal集成到主应用组件中
  - [x] 传递必要的项目数据到报告模态框
  - [x] 确保按钮位置和样式与现有界面一致

- [x] **报告生成逻辑** (AC: 4, 5)
  - [x] 实现基础报告模板，包含标题、时间范围、完成统计
  - [x] 生成结构化的完成事项列表（Markdown格式）
  - [x] 添加报告生成时间戳和基本元数据
  - [x] 实现文件下载功能，默认文件名包含日期范围

- [x] **界面样式和交互** (AC: 1-5)
  - [x] 为报告模态框添加合适的尺寸和布局
  - [x] 实现预览区域与编辑区域的合理分割
  - [x] 添加加载状态和生成进度提示
  - [x] 确保响应式设计，适配移动端

- [x] **测试和验证** (AC: 1-5)
  - [x] 测试日期选择器的各种使用场景
  - [x] 验证数据过滤逻辑的准确性
  - [x] 测试报告生成和导出功能
  - [x] 验证界面交互的流畅性和错误处理

## Dev Notes

### 系统架构上下文
基于项目架构和已完成的Story 5.1、5.2实现，该功能需要构建在现有的数据管理系统之上：

- **技术栈：** React 18 + TypeScript + Vite，使用 ShadCN UI 组件库
- **数据基础：** Story 5.1已实现的completedAt字段提供时间戳数据
- **设置集成：** Story 5.2的AI配置为后续AI报告生成提供参数基础

### 相关源码结构
```
src/
├── types/index.ts              # 需要添加报告相关类型定义
├── components/
│   ├── ReportModal.tsx         # 新建：报告生成模态框组件
│   └── ui/                     # 使用现有ShadCN组件
├── hooks/
│   └── useProjects.ts          # 获取项目数据进行报告生成
├── utils/
│   └── reportUtils.ts          # 新建：报告生成工具函数
└── pages/
    └── Index.tsx               # 主页面，集成报告生成按钮
```

### 现有模式参考
基于SettingsModal.tsx和已有组件的实现模式：

- **模态框结构：** 参考SettingsModal.tsx的Dialog组件使用模式
- **日期组件：** 使用项目已有的date-fns库和ShadCN DatePicker
- **文件下载：** 参考useLocalStorage.ts:23-31的download函数实现
- **数据处理：** 参考useProjects.ts的数据管理模式

### 集成Story 5.1的已有改动
- **数据基础：** Todo和Subtask的completedAt字段已实现并可用于时间过滤
- **UI基础：** 完成时间显示已集成，可在报告中引用显示格式
- **数据验证：** 时间戳格式已标准化为ISO 8601

### 关键实现注意事项

1. **报告数据结构：** 
   ```typescript
   interface ReportData {
     dateRange: { start: string; end: string };
     completedItems: {
       projectName: string;
       todos: Array<{
         content: string;
         completedAt: string;
         subtasks: Array<{
           content: string;
           completedAt: string;
         }>;
       }>;
     }[];
     statistics: {
       totalProjects: number;
       totalTodos: number;
       totalSubtasks: number;
     };
   }
   ```

2. **UI集成点：** 在主界面标题栏或工具栏区域添加报告生成按钮

3. **日期过滤逻辑：** 
   - 使用date-fns库进行日期比较和格式化
   - 过滤completedAt字段在指定范围内的事项
   - 处理无completedAt字段的旧数据

4. **Markdown模板：** 
   ```markdown
   # 工作报告 ({{startDate}} - {{endDate}})
   
   ## 完成统计
   - 完成项目：{{completedProjects}}个
   - 完成任务：{{completedTodos}}个
   - 完成子任务：{{completedSubtasks}}个
   
   ## 详细内容
   {{completedItemsList}}
   ```

### 与Epic 5后续故事的关联
- **为Story 5.4提供界面基础：** AI报告生成将扩展此界面，添加AI生成功能
- **配置集成：** 使用Story 5.2的AI配置进行后续的AI报告生成

### Testing

#### 测试文件位置和标准
基于项目架构和Stories 5.1-5.2的成功实现，测试文件应放置在：
- `src/__tests__/ReportModal.test.tsx` - 报告模态框组件测试
- `src/__tests__/utils/ReportUtils.test.ts` - 报告生成工具函数测试
- `src/__tests__/integration/ReportGeneration.test.tsx` - 报告生成集成测试

#### 测试框架和工具
继续使用项目标准测试技术栈：
- **测试框架：** Vitest
- **组件测试：** @testing-library/react + @testing-library/jest-dom
- **用户交互：** @testing-library/user-event
- **测试环境：** jsdom

#### 具体测试要求

##### 单元测试
1. **报告数据过滤测试**
   - 验证日期范围过滤的准确性
   - 测试边界情况（开始/结束日期边界）
   - 验证空数据和无效数据的处理

2. **组件行为测试**
   - 测试模态框的打开关闭行为
   - 验证日期选择器的交互
   - 测试报告内容编辑功能

3. **报告生成测试**
   - 验证Markdown格式的正确性
   - 测试统计数据的准确计算
   - 验证文件下载功能

##### 集成测试
1. **数据流测试**
   - 验证从项目数据到报告内容的完整数据流
   - 测试不同时间范围的报告生成
   - 验证报告内容的实时更新

2. **用户界面集成测试**
   - 测试主界面按钮与模态框的集成
   - 验证响应式设计在不同屏幕尺寸的表现
   - 测试错误状态和加载状态的显示

##### 用户界面测试
1. **交互流程测试**
   - 模拟完整的报告生成用户流程
   - 测试日期选择的各种操作方式
   - 验证报告编辑和导出的用户体验

2. **视觉一致性测试**
   - 确保报告模态框与现有设置模态框样式一致
   - 验证按钮和控件与现有组件风格匹配
   - 测试不同主题下的显示效果

#### 测试覆盖率要求
- 新增代码行覆盖率 ≥ 90%
- 分支覆盖率 ≥ 85%
- 报告生成核心逻辑覆盖率 = 100%

#### 回归测试
- 确保Story 5.1的完成时间功能不受影响
- 验证现有项目管理功能的正常工作
- 测试数据模型的向后兼容性

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-14 | 1.0 | 初始故事创建，基于Epic 5需求和Stories 5.1-5.2的成功实现 | BMad Master |

## Dev Agent Record

*(This section is owned by dev-agent and can only be modified by dev-agent)*

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
- 测试文件中处理了date-fns的locale问题，通过mock解决测试环境的兼容性
- 所有功能测试通过，包括11个测试用例
- ESLint检查通过，仅有预期的UI组件警告
- 生产构建成功

### Completion Notes List
- ✅ 成功创建ReportModal组件，实现完整的报告生成界面
- ✅ 集成日期选择器，支持快捷选择和自定义日期范围
- ✅ 实现完成事项数据过滤和统计功能，按时间范围准确筛选
- ✅ 在主界面添加报告生成按钮，UI集成完成
- ✅ 实现Markdown格式报告模板和导出功能
- ✅ 确保响应式设计和良好的用户体验
- ✅ 编写全面的测试用例，验证所有核心功能

### File List
- src/types/index.ts - 新增ReportData接口类型定义
- src/components/ReportModal.tsx - 新建报告生成模态框组件
- src/pages/Index.tsx - 修改，集成报告生成按钮和ReportModal
- src/__tests__/ReportModal.test.tsx - 新建测试文件，包含11个测试用例

## QA Results

*(This section is owned by qa-agent and can only be modified by qa-agent)*

*(Results from QA Agent QA review of the completed story implementation - to be populated during QA phase)*