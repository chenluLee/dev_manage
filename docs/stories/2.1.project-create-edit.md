# Story 2.1: 项目创建与编辑

## Status
Done

## Story
**作为** 独立开发者，
**我希望** 能够创建和编辑项目，
**以便** 组织我的开发工作。

## Acceptance Criteria
1. 支持创建新项目，包含项目名称和描述
2. 支持编辑现有项目的基本信息
3. 项目名称长度限制在合理范围内
4. 提供项目创建和编辑的即时保存功能
5. 支持项目删除操作，包含确认提示

## Tasks / Subtasks
- [x] 实现项目创建功能 (AC: 1, 4)
  - [x] 创建ProjectManager类，实现ProjectAPI.create()方法
  - [x] 设计项目数据模型验证逻辑
  - [x] 实现项目ID生成和时间戳管理
  - [x] 集成StorageManager的数据保存功能
  - [x] 添加项目创建成功的用户反馈
- [x] 实现项目编辑功能 (AC: 2, 4)
  - [x] 实现ProjectAPI.update()方法支持部分字段更新
  - [x] 创建项目编辑UI组件或模式
  - [x] 实现项目信息的即时保存机制
  - [x] 添加编辑状态的用户界面指示
  - [x] 处理编辑冲突和数据完整性
- [x] 实现项目删除功能 (AC: 5)
  - [x] 实现ProjectAPI.delete()方法
  - [x] 创建删除确认对话框
  - [x] 实现级联删除（项目下的所有任务）
  - [x] 添加删除操作的撤销功能（可选）
  - [x] 处理删除失败的错误情况
- [x] 实现数据验证和约束 (AC: 3)
  - [x] 创建项目名称长度验证（1-100字符）
  - [x] 实现项目描述长度验证（0-500字符）
  - [x] 添加项目名称重复检查
  - [x] 创建用户友好的验证错误提示
  - [x] 实现前端输入约束和即时反馈
- [x] 创建项目管理UI组件
  - [x] 设计和实现ProjectCard组件基础结构
  - [x] 实现项目信息显示（名称、描述、创建时间）
  - [x] 添加项目编辑和删除操作按钮
  - [x] 实现项目卡片的基础样式和布局
  - [x] 确保响应式设计支持
- [x] 单元测试 (所有AC)
  - [x] ProjectManager类的CRUD操作测试
  - [x] 数据验证功能测试
  - [x] ProjectCard组件渲染和交互测试
  - [x] 错误处理和边界条件测试
  - [x] 存储集成测试

## Dev Notes

### Previous Story Insights
来自Story 1.3 [Source: docs/stories/1.3.data-backup-restore.md]:
- StorageManager已具备完整的数据保存和加载功能
- File System Access API权限机制已建立且完善
- DataValidator已实现完整的数据验证功能
- 错误处理和用户反馈机制已完善
- 应用设置和状态管理机制已建立

来自Story 1.2 [Source: docs/stories/1.2.data-import-export.md]:
- StorageManager具备导入导出功能，可用于项目数据管理
- ValidationAPI已实现数据完整性验证
- 用户界面模式（Modal）已验证可用

来自Story 1.1 [Source: docs/stories/1.1.storage-path-setup.md]:
- 用户存储路径选择功能已完成
- IndexedDB降级方案已验证可用
- 文件系统访问权限请求机制已建立

### Data Models
**项目数据模型** [Source: architecture/data-models.md#Project Model]:
```typescript
interface Project {
  id: string;                    // 唯一标识符
  name: string;                  // 项目名称
  description?: string;          // 项目描述
  status: 'active' | 'completed'; // 项目状态
  createdAt: Date;               // 创建时间
  updatedAt: Date;               // 更新时间
  order: number;                 // 排序权重
  urls?: ProjectUrl[];           // 快速访问链接
  tags?: string[];               // 项目标签
  todos: Todo[];                 // 嵌套任务列表
}
```

**应用数据模型** [Source: architecture/data-models.md#Application Data Model]:
```typescript
interface AppData {
  version: string;               // 数据格式版本
  projects: Project[];           // 项目列表
  settings: AppSettings;         // 应用设置
  metadata: {
    createdAt: Date;
    lastModified: Date;
    totalProjects: number;
    totalTodos: number;
  };
}
```

### API Specifications
**项目管理API** [Source: architecture/api-specification.md#Project API]:
```javascript
// 创建新项目
ProjectAPI.create(projectData)
// 参数: projectData: Omit<Project, 'id' | 'createdAt' | 'updatedAt'>
// 返回: Promise<Project>

// 更新项目
ProjectAPI.update(id, updates)
// 参数: id: string, updates: Partial<Project>
// 返回: Promise<Project>

// 删除项目
ProjectAPI.delete(id)
// 参数: id: string
// 返回: Promise<boolean>

// 获取所有项目
ProjectAPI.getAll()
// 返回: Promise<Project[]>
```

**数据验证API** [Source: architecture/api-specification.md#Validation API]:
```javascript
// 验证项目数据
ValidationAPI.validateProject(projectData)
// 参数: projectData: Partial<Project>
// 返回: {valid: boolean, errors: string[]}
```

**存储API** [Source: architecture/api-specification.md#Storage API]:
```javascript
// 保存数据到文件系统
StorageAPI.saveToFile(data, filename?)
// 参数: data: AppData, filename?: string
// 返回: Promise<boolean>

// 从文件系统加载数据
StorageAPI.loadFromFile()
// 返回: Promise<AppData | null>
```

### Component Specifications
**ProjectCard组件** [Source: architecture/components.md#Core Components]:
- 位置：`assets/scripts/components/ProjectCard.js`
- 功能：完整的项目管理单元，包含项目信息、状态管理和任务展示
- 主要特性：项目基本信息展示和编辑、项目状态切换、嵌套任务列表管理

**项目管理工作流** [Source: architecture/core-workflows.md#项目管理工作流]:
1. 用户创建新项目
2. 用户界面调用ProjectAPI.create()
3. ProjectManager生成项目ID和时间戳
4. 调用StorageManager保存数据
5. 返回新项目并更新界面

### File Locations
基于项目结构 [Source: architecture/unified-project-structure.md]:
- **ProjectManager**: `assets/scripts/managers/ProjectManager.js`
- **ProjectCard组件**: `assets/scripts/components/ProjectCard.js`
- **工具函数**: `assets/scripts/utils/validation.js`
- **主应用入口**: `assets/scripts/app.js`（需要集成项目管理功能）

### Technical Constraints
**技术栈** [Source: architecture/tech-stack.md]:
- JavaScript ES2020+语法
- 原生Web APIs，无外部依赖
- HTML5语义化标签
- CSS3 Grid/Flexbox布局

**浏览器支持** [Source: architecture/tech-stack.md#Browser Support]:
- Chrome 80+ (主要目标)
- Firefox 75+ (完整支持)
- Safari 13+ (基本支持)
- Edge 80+ (完整支持)

**前端架构** [Source: architecture/frontend-architecture.md]:
- 模块化MVC，每个组件自包含
- 简单的发布-订阅模式状态管理
- 避免过度复杂化

**性能约束**：
- 项目创建和编辑操作应在200ms内完成
- 大量项目时界面响应应保持流畅
- 数据验证应实时进行，不阻塞用户输入

### Project Structure Notes
项目文件结构与架构文档一致 [Source: architecture/unified-project-structure.md]:
- 所有新增文件应遵循既定的目录结构
- 组件文件放在`assets/scripts/components/`目录
- 管理器文件放在`assets/scripts/managers/`目录
- 确保文件命名符合驼峰命名约定

### Testing
**测试框架** [Source: architecture/testing-strategy.md]:
- 单元测试：QUnit (轻量级，零依赖)
- 集成测试：Puppeteer
- 测试文件位置：`tests/unit/ProjectManager.test.js`、`tests/unit/ProjectCard.test.js`

**测试标准和要求**:
- 测试ProjectManager类的所有CRUD操作
- 测试数据验证功能的各种输入情况
- 测试ProjectCard组件的渲染和用户交互
- 测试错误处理和边界条件（空数据、非法输入等）
- 模拟存储操作和网络条件
- 性能测试：大量项目的创建和管理操作

**测试数据要求**:
- 创建不同复杂度的测试项目数据
- 准备无效数据进行验证测试
- 构建边界值测试用例（最大长度、空值等）
- 大数据量的性能测试用例

**编码规范** [Source: architecture/coding-standards.md]:
- 使用ES6+现代语法和class语法
- async/await处理异步操作
- 函数命名：动词开头，描述性（createProject, updateProjectData, validateProjectInput）
- 错误处理：try-catch包装，用户友好的错误提示
- BEM命名方法用于CSS类名

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-08-09 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References  
- 项目结构发现: 发现项目使用React+TypeScript而非原始JavaScript架构
- 测试Mock修复: 修复了useProjects测试中的module mock问题 
- 组件测试优化: 解决了ProjectCard测试中的Tooltip组件mock问题

### Completion Notes List
1. **ProjectManager类实现完成** - 实现了完整的CRUD操作，包含数据验证和StorageManager集成
2. **项目编辑功能增强** - 在ProjectCard组件中添加了实时验证和用户友好的错误提示
3. **删除确认对话框** - 使用AlertDialog组件实现了删除确认功能，防止误删除
4. **数据验证完整性** - 在useProjects hook中添加了完整的前端数据验证逻辑
5. **单元测试覆盖** - 创建了53个单元测试，覆盖所有核心功能和边界条件

### File List
**新创建的文件:**
- `src/managers/ProjectManager.ts` - 项目管理核心业务逻辑类
- `src/__tests__/ProjectManager.test.ts` - ProjectManager单元测试 (30个测试)
- `src/__tests__/useProjects.test.ts` - useProjects hook测试 (13个测试) 
- `src/__tests__/ProjectCard.test.tsx` - ProjectCard组件测试 (10个测试)

**修改的文件:**
- `src/components/ProjectCard.tsx` - 添加删除确认对话框和实时数据验证
- `src/hooks/useProjects.ts` - 增强了addProject和updateProject的数据验证逻辑
- `docs/stories/2.1.project-create-edit.md` - 更新任务完成状态和Dev Agent Record

## QA Results
*To be filled by QA agent*